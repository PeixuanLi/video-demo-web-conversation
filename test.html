<html>

<head>
    <meta charset="UTF-8">
    <title>Video测试页面</title>
</head>

<body style="background:#333;color:#fff;">
    <div style="text-align:center;font-size:30px;margin-top:50px;">wilddog video quickstart</div>
    <div id="getAppid-div" style="text-align:center;margin-top:30px;">
        <input id="appid" type="" name="" placeholder='请输入应用的 appId'>
        <button id="login" onclick="login()">登录</button>
    </div>
    <div id="videos" style="text-align:center;margin:0px auto;margin-top:80px;">
        <video id="local" style="border:1px solid;width:480px;height:360px;" autoplay=""></video>
        <video id="remote" style="border:1px solid;width:480px;height:360px;margin-left:50px;" hidden="" autoplay=""></video>
    </div>
    <div id="users" style="margin:0 auto;margin-top:70px;width:980px;">
        <div id="hangup" style="width:980px;height:50px;;text-align:center;position:absolute;margin-top:-50px;" hidden="">
            <button style="" onclick="disconnect()">挂断</button>
        </div>
        <div style="margin:0 auto;text-align:center;font-size:20px;margin-bottom:30px;">可邀请的在线用户列表</div>
        <div id="user-list" style="border:1px solid;float:left;width:100%;min-height:200px;">
            <div id="user-model" style="width:280px;height:30px;border:1px solid;margin:10px;float:left;" hidden="">
                <span class="remoteuid"></span>
                <button style="margin-top:3px;" onclick="invite(this.parentElement.id)">邀请</button>
            </div>
        </div>
    </div>
    <script type="text/javascript" src='https://cdn.wilddog.com/sdk/js/2.0.0/wilddog.js'></script>
    <script type="text/javascript" src='https://cdn.wilddog.com/sdk/js/0.2.0/wilddog-video.js'></script>
    <script type="text/javascript">
    var localEl = document.getElementById('local');
    var remoteEl = document.getElementById('remote');
    var appidEl = document.getElementById('appid');
    var userModel = document.getElementById('user-model');
    var userList = document.getElementById('user-list');
    var hangupEl = document.getElementById('hangup');
    var loginBtn = document.getElementById('login');
    var currentConversation = null;
    var wilddogref = null;
    var auth = null;

    var videoInstance = wilddog.video();

    var clientInstance = videoInstance.client();

    var localStream = null;

    videoInstance.createStream({
        audio: true,
        video: 'low'
    }, function(wdStream) {
        localStream = wdStream;
        localStream.attach(localEl);
    })

    var login = function() {
        var config = {
            authDomain: appidEl.value + '.wilddog.com',
            syncURL: "https://" + appid.value + ".wilddogio.com"
        };

        wilddog.initializeApp(config);
        wilddogref = wilddog.sync().ref("wilddogVideo");

        wilddog.auth().signInAnonymously().then((user) => {

            loginBtn.disabled = true;
            auth = user;

            wilddogref.child('users/' + user.uid).set(true);
            wilddogref.child('users/' + user.uid).onDisconnect().remove();

            clientInstance.init({
                ref: wilddogref,
                user: user
            }, () => {

                clientInstance.on('invite', (incomingInvite) => {

                    incomingInvite.accept(localStream).then((conversation) => {
                        console.log('accept');

                        currentConversation = conversation;
                        hangupEl.hidden = false;

                        userList.hidden = true;

                        wilddogref.child('users/' + user.uid).remove();

                        conversation.on('participant_connected', (participant) => {
                            remote.hidden = false;
                            participant.stream.attach(remote);
                        });
                        conversation.on('participant_disconnected', (participant) => {
                            console.log('participant_disconnected');
                            remote.hidden = true;
                            conversation.disconnect();
                            currentConversation = null;
                            hangupEl.hidden = true;
                            userList.hidden = false;
                            wilddogref.child('users/' + user.uid).set(true);
                        });
                    });
                });
            });

            wilddogref.child('users').on('child_added', (snap) => {
                if (snap.key() != user.uid) {
                    var newUser = userModel.cloneNode(true);
                    newUser.id = snap.key();
                    newUser.children[0].textContent = snap.key();
                    newUser.hidden = false;
                    userList.appendChild(newUser);
                }
            });

            wilddogref.child('users').on('child_removed', (snap) => {
                if (snap.key() != user.uid) {
                    var removeEl = document.getElementById(snap.key());
                    userList.removeChild(removeEl);
                }
            })

        }).catch(function(err) {

        });
    }

    var invite = function(uid) {
        console.log(uid);

        if (!currentConversation) {
            clientInstance.inviteToConversation({
                'mode': 'basic',
                'participantId': uid,
                'localStream': localStream,
            }).then((conversation) => {

                currentConversation = conversation;
                hangupEl.hidden = false;
                userList.hidden = true;

                conversation.on('participant_connected', (participant) => {
                    remote.hidden = false;
                    participant.stream.attach(remote);
                });
                conversation.on('participant_disconnected', (participant) => {
                    remote.hidden = true;
                    conversation.disconnect();
                    currentConversation = null;
                    hangupEl.hidden = true;
                    userList.hidden = false;
                    wilddogref.child('users/' + auth.uid).set(true);
                });
            });
        }
    }

    var disconnect = function() {
        if (currentConversation) {
            currentConversation.disconnect();
            hangup.hidden = true;
            currentConversation = null;
            remote.hidden = true;
        }
    }
    </script>
</body>

</html>
